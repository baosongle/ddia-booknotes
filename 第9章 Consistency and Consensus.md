# 第9章 Consistency and Consensus

在分布式系统中，可能会发生下面这些错误

- 数据在网络中丢失、延迟、乱序、重传
- 时钟不准确
- 进程暂停、崩溃

如何把这些错误隐藏，仅仅给业务开发者一个简单易懂的抽象，是很多分布式系统尝试解决的问题。这一章的主要内容有

- 最强的一致性模型：linearizability（线性一致性）
- 分布式系统的事件排序
- 分布式事务

## 一致性保证（Consistency Guarantees）

有些数据库提供一种叫做 Eventual Consistency （最终一致性）的保证，即在某个时间点，两个节点的数据可能不一致，但是经过足够长的时间后，节点的数据会一致。也就是说，节点之间的数据是相互收敛（convergence）的

在最终一致性下，如果你向分布式系统中的两个不同节点查询数据，得到的结果可能是不一样的。这对于程序员非常不友好。因此人们提出了 linearizability （线性一致性），在这个一致性模型下，分布式系统仿佛只有一个节点，在任意一个节点上的任意时间点，查询结果都是一样的

依赖于线性一致性的东西

- 分布式锁：多个客户端尝试获取同一个锁
- 唯一性约束：数据库中某一列的值必须是唯一的
- Cross-channel timing dependencies：这个问题的产生是因为系统中有多个数据传输通道，如果通道之间的传输没有同步，就会导致一些问题

如何实现线性一致性呢

- 只使用一个节点，那我们就没有高可用（falut tolerance）了
- Single-leader replication：如果客户端只从 leader 读取数据、或者 leader 向 follower 使用 synchronously 的方式发送数据，那么这个系统就是线性一致性的
- Consensus algorithms：一些共识算法可以实现线性一致性
- Multi-leader replication：无法实现线性一致性。因为在多主系统里，leader 与另一个 leader 之间的数据同步是异步的
- Leaderless replication：有可能实现，读取数据时，客户端的 read repair 必须是同步的；写入数据时，写入前必须读取 quorum 的节点的数据。这样实现会严重影响性能，大多数系统都没有实现

实现了线性一致性后，有哪些好处呢？根据 CAP 定理，在网络良好时，Consistency 和 Availibility 都可以实现；但是当网络发生分区后，这两者中只能选一个。但是 CAP 定理的问题在于，它只考虑了一种一致性模型和一种网络问题，即网络中断。但是现实中可能发生其他问题，包括网络延迟、丢包、重传等。因此 CAP 理论在现实中不太有用

大多数系统不实现线性一致性，就是因为性能会受很大的影响。根据一些研究，在线性一致性下，读和写的用时至少与网络延迟成正比

## 排序保证（Ordering Guarantees）