# 第1章 可靠、可扩展与可维护的应用系统

现在很多系统是数据密集型的（data-intensive）的、而不是计算密集型的（compute-intensive），意味着 CPU 已经不是性能的瓶颈了。系统的复杂度取决于 amount of data、complexity of data 和 speed at which data is changing

一个 data-intensive 应用通常会使用数据处理系统（data system）来作为我们的工具，比如数据库 database、缓存 caches、查询索引 search indexes、流处理 stream processing、批处理 batch processing

一个好的数据密集型应用该能够正确的使用这些工具，以达到 reliable、scalable 和 maintainable 的目的

近年来，随着数据处理系统的发展，出现了很多难以归类的非常规数据系统。比如内存数据库 Redis 可以用作消息队列，而消息队列 Kafka 却可以持久化数据

程序员现在写的应用程序也越来越复杂了，这要求我们需要灵活的组合不同的数据系统。

一个数据密集型应用要实现下面的要求

- 可靠性（reliablity）：比如说你的系统中有几个子系统崩溃了，整个系统不应当崩溃
- 伸缩性（scalability）：当数据量增大或者减小后，系统应该能够有简单的方法伸缩
- 可维护性（maintainability）：当需求变化后，系统应该能适应变化

为了验证系统的可靠性，我们可以故意杀死系统中的一些进程，Netflix Chaos Monkey 是一个这样的工具

对系统可靠性会造成影响的最大因素就是硬件错误了，包括断电、网络线缆终端、磁盘崩溃、甚至是内存错误等等。为减轻硬件故障的影响，我们可以为硬件增加冗余，如磁盘 RAID、备用电源等等。另外可以在软件层面使用 fault-tolerance 算法（使用 fault-tolerance 算法的另一个好处是可以逐个升级软件，而不会使整个系统停止服务）

硬件错误大多是相对独立的，软件错误可能就会相互影响了。这些错误包括操作系统层面的错误、系统资源（如 CPU）被一个进程完全占有、一个服务停止响应、一个服务的错误导致了另一个服务的错误。为了避免软件错误，程序员要仔细检查自己的程序依赖的假设，并在系统运行时检查假设是否成立

人为错误也非常常见。为减少人为错误，需要设计良好的 API、提供沙箱环境、大量的测试、快速恢复、监测

要设计一个可伸缩的系统，首先要确定系统的 load parameter，即一个能表示系统的处理数据量的指标。对于大多数的 Web 服务器来说，可能就是每秒处理数 QPS；对于缓存系统，可能是缓存命中率（hit rate）。得知了 load parameter 后我们才能确定一个适合的架构设计

一个系统的性能，可以使用 percentile 指标描述，常用的有 p50、p99 和 p999。如果说一个系统的 p50 是 200ms，表示 50% 的请求可以在 200ms 内返回结果；p99 是 1s，即 99% 的请求可以在 1s 内返回结果。较高的延迟会严重影响用户体验

对系统进行拓展的方式有两种，垂直拓展（scaling up）和水平拓展（scaling out）。垂直拓展表示使用性能更强的单机，水平拓展指使用更多的机器。一个无状态的系统（stateless）非常适合于水平拓展

并没有一种通用的分布式系统的架构设计方式，一个架构可能只适合一个系统

系统还需要有很好的可维护性，使运维人员可以方便的部署、监测应用程序。系统也要设计的简单，使得开发人员容易理解系统